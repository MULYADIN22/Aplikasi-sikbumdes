<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Sik-BUMDes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .dark ::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .dark ::-webkit-scrollbar-thumb {
            background: #718096;
        }
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        /* Sidebar transition */
        #sidebar {
            transition: margin-left 0.3s ease-in-out;
        }
        #main-wrapper {
            transition: margin-left 0.3s ease-in-out;
        }
        
        @media (min-width: 1024px) {
            #main-wrapper {
                margin-left: 16rem; /* Default margin is full sidebar width */
            }
            #sidebar:not(:hover) {
                margin-left: -14rem; /* Hide most of it, leave 2rem visible */
            }
            #sidebar:not(:hover) + #main-wrapper {
                margin-left: 2rem; /* Adjust main content margin to match visible part */
            }
        }
        
        .modal {
            display: none;
        }
        .modal.show {
            display: flex;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 2rem;
                color: black;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <!-- Login Page -->
    <div id="login-page" class="fixed inset-0 bg-gradient-to-br from-teal-400 to-blue-500 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-center mb-6">
                <i class="fas fa-landmark fa-3x text-teal-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-2">Sik-BUMDes Login</h2>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Selamat Datang Kembali</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Username</label>
                    <input type="text" id="username" name="username" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500" required>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:from-teal-600 hover:to-blue-700 transition duration-300">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Main Application Wrapper -->
    <div id="app-wrapper" class="hidden lg:flex">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-white dark:bg-gray-800 text-gray-800 dark:text-white w-64 fixed inset-y-0 left-0 z-40 shadow-lg transform -translate-x-full lg:translate-x-0 lg:relative flex-shrink-0">
            <div class="p-4 flex items-center justify-center border-b border-gray-200 dark:border-gray-700">
                <i class="fas fa-landmark fa-2x text-teal-500 mr-3"></i>
                <h1 class="text-2xl font-bold">Sik-BUMDes</h1>
            </div>
            <nav class="p-4">
                <ul class="space-y-2">
                    <li><a href="#home" class="nav-link active flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-home w-6 mr-3"></i>Dashboard</a></li>
                    <li><a href="#input-data" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-keyboard w-6 mr-3"></i>Input Data</a></li>
                    <li><a href="#unit-usaha" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-store w-6 mr-3"></i>Unit Usaha</a></li>
                    <li><a href="#laporan" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-file-alt w-6 mr-3"></i>Laporan</a></li>
                    <li><a href="#administrasi" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-folder-open w-6 mr-3"></i>Administrasi</a></li>
                    <li><a href="#pengaturan" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-cog w-6 mr-3"></i>Pengaturan</a></li>
                    <li><a href="#bantuan" class="nav-link flex items-center p-3 rounded-lg hover:bg-teal-500 hover:text-white transition-colors"><i class="fas fa-question-circle w-6 mr-3"></i>Bantuan</a></li>
                    <li><a href="#" id="logout-btn" class="flex items-center p-3 rounded-lg hover:bg-red-500 hover:text-white transition-colors"><i class="fas fa-sign-out-alt w-6 mr-3"></i>Logout</a></li>
                </ul>
            </nav>
        </aside>

        <div id="main-wrapper" class="flex flex-col flex-1 w-full">
            <!-- Header -->
            <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-30 no-print">
                <div class="flex items-center">
                     <button id="menu-toggle" class="lg:hidden text-gray-600 dark:text-gray-300 focus:outline-none">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold ml-4">Dashboard</h2>
                </div>
                <div class="flex items-center">
                    <button id="theme-toggle" class="mr-4 text-gray-600 dark:text-gray-300 focus:outline-none">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div id="user-info" class="text-right">
                        <p class="font-semibold">Nama Pengguna</p>
                        <p class="text-sm text-gray-500">Peran</p>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main id="main-content" class="flex-1 p-6 overflow-y-auto">
                
                <!-- Home Page -->
                <div id="home-page" class="page">
                    <!-- BUMDes Header -->
                    <div class="bg-gradient-to-r from-teal-500 to-blue-600 text-white p-6 rounded-xl shadow-lg mb-6">
                        <div class="flex items-center">
                            <img id="dashboard-logo" src="https://placehold.co/80x80/FFFFFF/333333?text=Logo" alt="Logo BUMDes" class="w-20 h-20 rounded-full border-4 border-white mr-6">
                            <div>
                                <h2 id="dashboard-nama-bumdes" class="text-3xl font-bold">Nama BUMDes</h2>
                                <p id="dashboard-alamat" class="mt-1">Alamat Lengkap BUMDes</p>
                                <p id="dashboard-ahu" class="text-sm bg-white text-teal-600 font-bold px-3 py-1 rounded-full inline-block mt-2">Nomor AHU: -</p>
                            </div>
                        </div>
                    </div>

                    <!-- Financial Summary Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                        <!-- Card Template -->
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-teal-100 dark:bg-teal-800 p-4 rounded-full mr-4">
                                <i class="fas fa-wallet fa-2x text-teal-500"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Aktiva</p>
                                <p id="summary-aktiva" class="text-2xl font-bold">Rp 0</p>
                            </div>
                        </div>
                         <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-blue-100 dark:bg-blue-800 p-4 rounded-full mr-4">
                                <i class="fas fa-balance-scale fa-2x text-blue-500"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Total Pasiva</p>
                                <p id="summary-pasiva" class="text-2xl font-bold">Rp 0</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-green-100 dark:bg-green-800 p-4 rounded-full mr-4">
                                <i class="fas fa-arrow-up fa-2x text-green-500"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Pendapatan Bulan Ini</p>
                                <p id="summary-pendapatan" class="text-2xl font-bold">Rp 0</p>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-red-100 dark:bg-red-800 p-4 rounded-full mr-4">
                                <i class="fas fa-arrow-down fa-2x text-red-500"></i>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Biaya Bulan Ini</p>
                                <p id="summary-biaya" class="text-2xl font-bold">Rp 0</p>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Info -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold mb-4">Grafik Laba/Rugi (6 Bulan Terakhir)</h3>
                            <canvas id="labaRugiChart"></canvas>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="font-semibold mb-4">Informasi Singkat</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center">
                                        <span><i class="fas fa-users text-blue-500 mr-2"></i> Pelanggan/Anggota</span>
                                        <span id="info-pelanggan" class="font-bold">0</span>
                                    </div>
                                    <div class="flex justify-between items-center">
                                        <span><i class="fas fa-exchange-alt text-green-500 mr-2"></i> Transaksi Hari Ini</span>
                                        <span id="info-transaksi" class="font-bold">0</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="font-semibold mb-4">Notifikasi Penting</h3>
                                <ul id="notifikasi-list" class="space-y-2 text-sm">
                                    <li class="text-gray-500">Tidak ada notifikasi.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Input Data Page -->
                <div id="input-data-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Input Data Awal & Master</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                             <button id="btn-show-identitas" class="bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center justify-center"><i class="fas fa-id-card mr-2"></i>Identitas BUMDes</button>
                            <button id="btn-show-coa" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center"><i class="fas fa-list-ol mr-2"></i>Daftar Akun (COA)</button>
                            <button id="btn-show-jurnal" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 flex items-center justify-center"><i class="fas fa-book mr-2"></i>Input Jurnal</button>
                            <button id="btn-show-inventaris" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-300 flex items-center justify-center"><i class="fas fa-boxes mr-2"></i>Input Inventaris</button>
                            <button id="btn-show-sewa" class="bg-orange-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-orange-600 transition duration-300 flex items-center justify-center"><i class="fas fa-building mr-2"></i>Input Biaya Sewa</button>
                        </div>
                        
                        <!-- Dynamic content area -->
                        <div id="input-data-content">
                            <p class="text-center text-gray-500">Pilih salah satu tombol di atas untuk memulai.</p>
                        </div>
                    </div>
                </div>

                <!-- Unit Usaha Page -->
                <div id="unit-usaha-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Manajemen Unit Usaha</h2>
                            <button id="btn-tambah-unit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 transition duration-300"><i class="fas fa-plus mr-2"></i>Tambah Unit</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead class="bg-gray-100 dark:bg-gray-700">
                                    <tr>
                                        <th class="p-3">Nama Unit Usaha</th>
                                        <th class="p-3">Deskripsi</th>
                                        <th class="p-3">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="unit-usaha-table-body">
                                    <!-- Data will be populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Laporan Page -->
                <div id="laporan-page" class="page hidden">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Laporan Keuangan & Operasional</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-6">
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="buku-besar">Buku Besar</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="neraca-saldo">Neraca Saldo</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="laba-rugi">Laba Rugi</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="posisi-keuangan">Posisi Keuangan</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="arus-kas">Arus Kas</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="inventaris">Daftar Inventaris</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="biaya-sewa">Biaya Sewa</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="penjualan">Penjualan</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-teal-500 hover:text-white" data-report="stok">Stok Barang</button>
                        </div>
                        <div id="laporan-controls" class="flex items-center space-x-4 mb-4">
                            <!-- Controls will be added here by JS -->
                        </div>
                        <div id="laporan-content" class="border dark:border-gray-700 rounded-lg p-4 min-h-[300px]">
                            <p class="text-center text-gray-500">Pilih jenis laporan untuk ditampilkan.</p>
                        </div>
                    </div>
                </div>

                <!-- Administrasi Page -->
                <div id="administrasi-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Administrasi & Legalitas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Dokumen Legalitas -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Dokumen Legalitas</h3>
                                <form id="form-upload-dokumen" class="space-y-3">
                                    <select id="select-jenis-dokumen" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                                        <option value="perdes">Perdes Pendirian</option>
                                        <option value="adart">AD/ART</option>
                                        <option value="sk">SK Pengurus</option>
                                        <option value="sertifikat">Sertifikat Badan Hukum</option>
                                    </select>
                                    <input type="file" id="input-file-dokumen" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                                    <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600 w-full">Upload Dokumen</button>
                                </form>
                                <div id="list-dokumen" class="mt-4 space-y-2"></div>
                            </div>
                            <!-- Catatan Musyawarah Desa -->
                            <div>
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Catatan Musyawarah Desa</h3>
                                <form id="form-musyawarah" class="space-y-3">
                                    <input type="date" id="input-tanggal-musyawarah" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">
                                    <textarea id="input-hasil-musyawarah" rows="3" placeholder="Hasil Keputusan..." class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"></textarea>
                                    <input type="file" id="input-foto-musyawarah" accept="image/*" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                                    <input type="file" id="input-berita-acara" accept=".pdf,.doc,.docx" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 w-full">Simpan Catatan</button>
                                </form>
                                <div id="list-musyawarah" class="mt-4 space-y-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pengaturan Page -->
                <div id="pengaturan-page" class="page hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Manajemen Pengguna -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Manajemen Pengguna</h2>
                                <button id="btn-tambah-pengguna" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left">
                                    <thead class="bg-gray-100 dark:bg-gray-700">
                                        <tr>
                                            <th class="p-3">Username</th>
                                            <th class="p-3">Peran</th>
                                            <th class="p-3">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="pengguna-table-body"></tbody>
                                </table>
                            </div>
                        </div>
                        <!-- Pengaturan Lain -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md space-y-6">
                            <div>
                                <h2 class="text-xl font-bold mb-2">Upload Logo BUMDes</h2>
                                <div class="flex items-center space-x-4">
                                    <img id="logo-preview" src="https://placehold.co/80x80/e2e8f0/333333?text=Logo" class="w-20 h-20 rounded-full border">
                                    <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                                </div>
                                 <button id="btn-simpan-logo" class="mt-2 bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Simpan Logo</button>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">Data Aplikasi</h2>
                                <div class="flex space-x-4">
                                    <button id="btn-backup-data" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex-1"><i class="fas fa-download mr-2"></i>Backup Data</button>
                                    <label for="restore-upload" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex-1 text-center cursor-pointer"><i class="fas fa-upload mr-2"></i>Restore Data</label>
                                    <input type="file" id="restore-upload" class="hidden" accept=".json">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bantuan Page -->
                <div id="bantuan-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Bantuan & FAQ</h2>
                        <div class="space-y-4">
                            <div>
                                <h3 class="font-semibold">Bagaimana cara memulai?</h3>
                                <p>Mulai dengan mengisi 'Identitas BUMDes' di menu 'Input Data'. Selanjutnya, periksa dan sesuaikan 'Daftar Akun (COA)' jika perlu. Setelah itu, Anda bisa mulai mencatat transaksi melalui 'Input Jurnal'.</p>
                            </div>
                            <div>
                                <h3 class="font-semibold">Bagaimana cara melihat laporan?</h3>
                                <p>Pergi ke menu 'Laporan', lalu pilih jenis laporan yang ingin Anda lihat (misal: Laba Rugi). Anda bisa mengatur periode laporan dan mencetaknya.</p>
                            </div>
                            <div>
                                <h3 class="font-semibold">Apakah data saya aman?</h3>
                                <p>Semua data disimpan di browser Anda (localStorage). Data tidak dikirim ke server manapun. Untuk keamanan, lakukan 'Backup Data' secara berkala melalui menu 'Pengaturan'.</p>
                            </div>
                        </div>
                        <div class="mt-8 text-center">
                            <a href="https://wa.me/6281991810355?text=Halo%20Admin%20Sik-BUMDes,%20saya%20butuh%20bantuan." target="_blank" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300 inline-flex items-center">
                                <i class="fab fa-whatsapp mr-2"></i>Chat Administrator
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
                    ©2025 Sinar Jaya Digital Solusi
                </footer>
            </main>
        </div>
    </div>
    
    <!-- Modals will be appended here -->
    <div id="modal-container"></div>
    
    <!-- Print Area -->
    <div id="print-area" class="hidden"></div>


<script>
// Main script for Sik-BUMDes Application
document.addEventListener('DOMContentLoaded', () => {

    // --- UTILITY FUNCTIONS ---
    const formatCurrency = (amount) => {
        if (typeof amount !== 'number') return 'Rp 0';
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    };

    const el = (selector) => document.querySelector(selector);
    const all = (selector) => document.querySelectorAll(selector);

    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-50 transition-transform transform translate-x-full ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.remove('translate-x-full');
        }, 100);

        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // --- INITIALIZATION ---
    let sikBumdesData;
    let labaRugiChart;

    function initializeApp() {
        // Load data from localStorage or set default
        sikBumdesData = JSON.parse(localStorage.getItem('sikBumdesData'));
        if (!sikBumdesData) {
            sikBumdesData = getDefaultData();
            saveData();
        }
        
        // Theme initialization
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            el('#theme-toggle i').classList.replace('fa-moon', 'fa-sun');
        } else {
            document.documentElement.classList.remove('dark');
            el('#theme-toggle i').classList.replace('fa-sun', 'fa-moon');
        }

        // Check login status
        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (loggedInUser) {
            showApp();
            updateUserInfo(loggedInUser);
            navigateTo('home');
        } else {
            showLogin();
        }
    }

    function getDefaultData() {
        return {
            identitas: {
                nama: "BUMDes Desa Mandiri",
                status: "BUMDesa",
                perdesNo: "", perdesTgl: "",
                perkadesNo: "", perkadesTgl: "",
                skKadesNo: "", skKadesTgl: "",
                adart: "",
                statusAktif: "Aktif",
                peringkat: "Level C (Pemula)",
                periode: new Date().getFullYear(),
                ahu: "AHU-12345.AH.01.01",
                kodeDesa: "",
                alamat: { desa: "Desa Mandiri", kec: "Kec. Sejahtera", kab: "Kab. Maju", prov: "Prov. Indonesia", jalan: "Jl. Pembangunan No. 1" },
                penasihat: { nama: "", hp: "", alamat: "", periode: "" },
                pengelola: {
                    direktur: { nama: "John Doe", hp: "", alamat: "", nik: "", periode: "" },
                    sekretaris: { nama: "", hp: "", alamat: "", nik: "", periode: "" },
                    bendahara: { nama: "", hp: "", alamat: "", nik: "", periode: "" },
                },
                pengawas: [ 
                    { nama: "", hp: "", alamat: "", nik: "", periode: "" }, 
                    { nama: "", hp: "", alamat: "", nik: "", periode: "" }, 
                    { nama: "", hp: "", alamat: "", nik: "", periode: "" }, 
                    { nama: "", hp: "", alamat: "", nik: "", periode: "" }, 
                    { nama: "", hp: "", alamat: "", nik: "", periode: "" } 
                ],
                pendamping: { 
                    desa: { nama: "", hp: "", alamat: "", nik: "", periode: "" }, 
                    lokal: { nama: "", hp: "", alamat: "", nik: "", periode: "" } 
                }
            },
            coa: [
                { no: '1.1.01.01', nama: 'Kas' }, { no: '1.1.02.01', nama: 'Bank BRI' }, { no: '1.1.02.02', nama: 'Bank 2' },
                { no: '1.1.03.01', nama: 'Deposit Tiket' }, { no: '1.1.03.02', nama: 'Piutang Usaha' }, { no: '1.1.03.03', nama: 'Piutang Karyawan' },
                { no: '1.1.05.01', nama: 'Persediaan Barang Dagang Unit Gas Elpiji' }, { no: '1.1.06.01', nama: 'Perlengkapan Kantor' },
                { no: '1.1.07.01', nama: 'Pajak PPn Masukan' }, { no: '1.1.07.02', nama: 'Pajak dibayar dimuka PPh 23' },
                { no: '1.1.08.02', nama: 'Uang Muka/Pinjaman kepada Karyawan' }, { no: '1.1.08.03', nama: 'Uang muka Pembelian' },
                { no: '1.1.08.04', nama: 'Cash Advance' }, { no: '1.1.08.06', nama: 'Cashbon/Pinjaman' }, { no: '1.1.08.07', nama: 'Sewa di bayar dimuka' },
                { no: '1.2.01.02', nama: 'Bangunan' }, { no: '1.2.01.03', nama: 'Kendaraan' }, { no: '1.2.01.05', nama: 'Inventaris Kantor' },
                { no: '1.2.01.07', nama: 'Akumulasi Penyusutan Bangunan' }, { no: '1.2.01.08', nama: 'Akumulasi Penyusutan Kendaraan' },
                { no: '1.2.01.09', nama: 'Akumulasi Penyusutan Sewa dibayar dimuka' }, { no: '1.2.01.10', nama: 'Akumulasi Penyusutan Inventaris Kantor' },
                { no: '1.2.04.01', nama: 'Kitchen Machinery (Perlengkapan Dapur)' }, { no: '2.1.01.01', nama: 'Utang Usaha' },
                { no: '2.1.02.01', nama: 'Utang PPn Keluaran' }, { no: '2.1.02.02', nama: 'Utang PPh 21' }, { no: '2.1.02.04', nama: 'Utang PPh 23' },
                { no: '2.1.03.01', nama: 'Utang Gaji/Upah' }, { no: '2.1.03.02', nama: 'Utang BPJS Kesehatan' }, { no: '2.1.03.06', nama: 'Utang Deposit' },
                { no: '2.1.04.04', nama: 'Pendapatan diterima dimuka' }, { no: '2.1.04.05', nama: 'Utang Lainnya' },
                { no: '3.1.01.01', nama: 'Modal dari Desa' }, { no: '3.1.01.02', nama: 'Utang Direksi' }, { no: '3.1.01.03', nama: 'Modal dari Masyarakat' },
                { no: '3.1.01.04', nama: 'Hibah' }, { no: '3.1.02.01', nama: 'Saldo Laba ditahan' }, { no: '3.1.02.02', nama: 'Saldo Laba tahun berjalan' },
                { no: '4.1.01', nama: 'Pendapatan Unit Gas Elpiji' }, { no: '5.1.0.01', nama: 'HPP Unit Gas Elpiji' },
                { no: '5.1.01.01', nama: 'Biaya Gaji/Upah Produksi Unit Gas Elpiji' }, { no: '5.1.01.06', nama: 'Biaya Insentif dan Bonus Unit Gas Elpiji' },
                { no: '5.1.01.08', nama: 'Biaya Produksi Unit Gas Elpiji' }, { no: '5.1.01.09', nama: 'Biaya Medis Unit Gas Elpiji' },
                { no: '5.1.01.10', nama: 'Biaya Perjalanan Dinas Unit Unit Gas Elpiji' }, { no: '5.1.01.11', nama: 'Biaya Transportasi, bbm, Toll dan Parkir Unit Gas Elpiji' },
                { no: '5.1.01.12', nama: 'Biaya Listrik dan PDAM Unit Gas Elpiji' }, { no: '5.1.01.13', nama: 'Biaya Gas Unit Gas Elpiji' },
                { no: '5.1.01.16', nama: 'Biaya Keamanan dan Kebersihan Unit Gas Elpiji' }, { no: '5.1.01.18', nama: 'Biaya ATK dan Fotocopy Unit Gas Elpiji' },
                { no: '5.1.01.19', nama: 'Biaya Perlengkapan Unit Gas Elpiji' }, { no: '5.1.01.20', nama: 'Pembelian Inventaris Unit Gas Elpiji' },
                { no: '5.1.01.22', nama: 'Biaya Servis dan Pemeliharaan Unit Gas Elpiji' }, { no: '5.1.01.23', nama: 'Biaya Sewa dibayar dimuka Unit Gas Elpiji' },
                { no: '5.1.01.24', nama: 'Biaya Entertaiment dan Representasi Unit Gas Elpiji' }, { no: '5.1.01.33', nama: 'Biaya Operasional Lainnya Unit Gas Elpiji' },
                { no: '5.1.01.34', nama: 'Biaya Penyusutan Bangunan Kantor Unit Gas Elpiji' }, { no: '5.1.01.35', nama: 'Biaya Penyusutan Kendaraan Unit Gas Elpiji' },
                { no: '5.1.01.36', nama: 'Biaya Penyusutan Inventaris Kantor Unit Gas Elpiji' }, { no: '5.1.08.01', nama: 'Gaji+tunjangan (Penasihat,Direktur,Sekretaris,Bendahara dan Pengawas)' },
                { no: '5.1.08.06', nama: 'Biaya Insentif dan Bonus Pengurus BUM Desa' }, { no: '5.1.08.08', nama: 'Biaya Makan Pengurus BUM Desa' },
                { no: '5.1.08.09', nama: 'Biaya Medis Pengurus BUM Desa' }, { no: '5.1.08.10', nama: 'Biaya Perjalanan Dinas Pengurus BUM Desa' },
                { no: '5.1.08.11', nama: 'Biaya Transportasi, bbm, Toll dan Parkir Pengurus BUM Desa' }, { no: '5.1.08.12', nama: 'Biaya Listrik dan PDAM BUM Desa' },
                { no: '5.1.08.13', nama: 'Biaya Gas BUM Desa' }, { no: '5.1.08.16', nama: 'Biaya Keamanan dan Kebersihan BUM Desa' },
                { no: '5.1.08.18', nama: 'Biaya ATK dan Fotocopy BUM Desa' }, { no: '5.1.08.19', nama: 'Biaya Perlengkapan BUM Desa' },
                { no: '5.1.08.20', nama: 'Pembelian Inventaris BUM Desa' }, { no: '5.1.08.22', nama: 'Biaya Servis dan Pemeliharaan BUM Desa' }, { no: '5.1.08.23', nama: 'Biaya Sewa dibayar dimuka BUMDes' }, { no: '5.1.08.24', nama: 'Biaya Entertaiment dan Representasi BUM Desa' },
                { no: '5.1.08.33', nama: 'Biaya Operasional Lainnya BUM Desa' }, { no: '5.1.08.34', nama: 'Biaya Penyusutan Bangunan Kantor BUM Desa' },
                { no: '5.1.08.35', nama: 'Biaya Penyusutan Kendaraan BUM Desa' }, { no: '5.1.08.36', nama: 'Biaya Penyusutan Inventaris Kantor BUM Desa' },
            ],
            jurnal: [],
            jurnalCounter: {},
            inventaris: [],
            biayaSewa: [],
            unitUsaha: [{ id: 'utama', nama: 'Kantor Utama', deskripsi: 'Kegiatan operasional utama BUMDes' }],
            dokumen: { perdes: null, adart: null, sk: null, sertifikat: null },
            musyawarah: [],
            pengguna: [{ username: 'admin', password: 'password', peran: 'Admin' }],
            pengaturan: { logo: 'https://placehold.co/80x80/FFFFFF/333333?text=Logo' }
        };
    }

    function saveData() {
        localStorage.setItem('sikBumdesData', JSON.stringify(sikBumdesData));
    }

    // --- AUTHENTICATION ---
    function showLogin() {
        el('#login-page').style.display = 'flex';
        el('#app-wrapper').classList.add('hidden');
    }

    function showApp() {
        el('#login-page').style.display = 'none';
        el('#app-wrapper').classList.remove('hidden');
        el('#app-wrapper').classList.add('lg:flex');
    }
    
    function updateUserInfo(user) {
        const userInfo = el('#user-info');
        userInfo.querySelector('p:first-child').textContent = user.username;
        userInfo.querySelector('p:last-child').textContent = user.peran;
    }

    el('#login-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const username = e.target.username.value;
        const password = e.target.password.value;
        const user = sikBumdesData.pengguna.find(u => u.username === username && u.password === password);

        if (user) {
            sessionStorage.setItem('loggedInUser', JSON.stringify(user));
            el('#login-error').textContent = '';
            showApp();
            updateUserInfo(user);
            navigateTo('home');
        } else {
            el('#login-error').textContent = 'Username atau password salah.';
        }
    });

    el('#logout-btn').addEventListener('click', (e) => {
        e.preventDefault();
        sessionStorage.removeItem('loggedInUser');
        showLogin();
    });

    // --- NAVIGATION ---
    function navigateTo(pageId) {
        all('.page').forEach(page => page.classList.add('hidden'));
        el(`#${pageId}-page`).classList.remove('hidden');
        
        all('.nav-link').forEach(link => link.classList.remove('active', 'bg-teal-500', 'text-white'));
        const activeLink = el(`.nav-link[href="#${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active', 'bg-teal-500', 'text-white');
            el('#page-title').textContent = activeLink.textContent;
        }

        // Load content for the page
        switch (pageId) {
            case 'home':
                renderDashboard();
                break;
            case 'unit-usaha':
                renderUnitUsahaTable();
                break;
            case 'administrasi':
                renderDokumenList();
                renderMusyawarahList();
                break;
            case 'pengaturan':
                renderPenggunaTable();
                loadPengaturan();
                break;
        }
    }

    all('.nav-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const pageId = link.getAttribute('href').substring(1);
            navigateTo(pageId);
        });
    });
    
    // Mobile menu toggle
    el('#menu-toggle').addEventListener('click', () => {
        el('#sidebar').classList.toggle('-translate-x-full');
        el('#sidebar').classList.toggle('lg:translate-x-0');
    });


    // --- THEME TOGGLE ---
    el('#theme-toggle').addEventListener('click', () => {
        const html = document.documentElement;
        html.classList.toggle('dark');
        const isDark = html.classList.contains('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        el('#theme-toggle i').classList.toggle('fa-moon', !isDark);
        el('#theme-toggle i').classList.toggle('fa-sun', isDark);
    });

    // --- DASHBOARD ---
    function renderDashboard() {
        const { identitas, pengaturan } = sikBumdesData;
        el('#dashboard-logo').src = pengaturan.logo;
        el('#dashboard-nama-bumdes').textContent = identitas.nama;
        el('#dashboard-alamat').textContent = `${identitas.alamat.jalan}, ${identitas.alamat.desa}, ${identitas.alamat.kec}, ${identitas.alamat.kab}`;
        el('#dashboard-ahu').textContent = `Nomor AHU: ${identitas.ahu || '-'}`;

        // Financial calculations
        const { totals } = calculateLedger();
        const aktiva = (totals['1'] || 0);
        const pasiva = (totals['2'] || 0) + (totals['3'] || 0);
        
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();

        const { pendapatan, biaya } = calculateMonthlyTotals(currentYear, currentMonth);

        el('#summary-aktiva').textContent = formatCurrency(aktiva);
        el('#summary-pasiva').textContent = formatCurrency(pasiva);
        el('#summary-pendapatan').textContent = formatCurrency(pendapatan);
        el('#summary-biaya').textContent = formatCurrency(biaya);
        
        const todayStr = new Date().toISOString().slice(0, 10);
        const transaksiHariIni = sikBumdesData.jurnal.filter(j => j.tanggal === todayStr).length / 2;
        el('#info-transaksi').textContent = Math.floor(transaksiHariIni);

        renderLabaRugiChart();
    }

    function calculateLedger() {
        const ledger = {};
        sikBumdesData.jurnal.forEach(entry => {
            if (!ledger[entry.akunNo]) {
                ledger[entry.akunNo] = { debit: 0, credit: 0, balance: 0, entries: [] };
            }
            ledger[entry.akunNo].debit += entry.debit;
            ledger[entry.akunNo].credit += entry.credit;
            ledger[entry.akunNo].entries.push(entry);
        });

        const totals = {};
        for (const akunNo in ledger) {
            const akun = sikBumdesData.coa.find(c => c.no === akunNo);
            if (!akun) continue;
            
            const type = akunNo.charAt(0);
            const { debit, credit } = ledger[akunNo];
            let balance = 0;

            // Normal balance calculation
            if (['1', '5'].includes(type)) { // Aset, Biaya
                balance = debit - credit;
            } else if (['2', '3', '4'].includes(type)) { // Kewajiban, Ekuitas, Pendapatan
                balance = credit - debit;
            }
            ledger[akunNo].balance = balance;

            const mainType = akunNo.charAt(0);
            if (!totals[mainType]) totals[mainType] = 0;
            totals[mainType] += balance;
        }
        return { ledger, totals };
    }

    function calculateMonthlyTotals(year, month) {
        let pendapatan = 0;
        let biaya = 0;
        sikBumdesData.jurnal.forEach(j => {
            const jDate = new Date(j.tanggal);
            if (jDate.getFullYear() === year && jDate.getMonth() === month) {
                if (j.akunNo.startsWith('4')) {
                    pendapatan += j.credit;
                } else if (j.akunNo.startsWith('5')) {
                    biaya += j.debit;
                }
            }
        });
        return { pendapatan, biaya };
    }

    function renderLabaRugiChart() {
        const ctx = el('#labaRugiChart').getContext('2d');
        const labels = [];
        const labaData = [];
        const rugiData = [];

        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const year = d.getFullYear();
            const month = d.getMonth();
            
            labels.push(d.toLocaleString('id-ID', { month: 'short' }));
            const { pendapatan, biaya } = calculateMonthlyTotals(year, month);
            const labaRugi = pendapatan - biaya;
            
            labaData.push(labaRugi > 0 ? labaRugi : 0);
            rugiData.push(labaRugi < 0 ? -labaRugi : 0);
        }

        if (labaRugiChart) {
            labaRugiChart.destroy();
        }

        labaRugiChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Laba',
                        data: labaData,
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Rugi',
                        data: rugiData,
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: { stacked: true },
                    y: { 
                        stacked: true,
                        ticks: {
                            callback: function(value) {
                                return formatCurrency(value);
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += formatCurrency(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- INPUT DATA PAGE ---
    const inputDataContent = el('#input-data-content');
    
    el('#btn-show-identitas').addEventListener('click', () => showIdentitasForm());
    el('#btn-show-coa').addEventListener('click', () => showCoaTable());
    el('#btn-show-jurnal').addEventListener('click', () => showJurnalForm());
    el('#btn-show-inventaris').addEventListener('click', () => showInventarisForm());
    el('#btn-show-sewa').addEventListener('click', () => showSewaForm());
    
    // --- Identitas BUMDes ---
    function showIdentitasForm() {
        const { identitas } = sikBumdesData;
        let pengawasHtml = '';
        for(let i=0; i < 5; i++) {
            pengawasHtml += `
                <div class="p-3 border rounded-lg dark:border-gray-600">
                    <h5 class="font-semibold mb-2">Pengawas ${i+1}</h5>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <div><label class="block text-sm">Nama</label><input type="text" name="pengawas_nama_${i}" value="${identitas.pengawas[i].nama}" class="form-input"></div>
                        <div><label class="block text-sm">No. HP</label><input type="text" name="pengawas_hp_${i}" value="${identitas.pengawas[i].hp}" class="form-input"></div>
                        <div><label class="block text-sm">NIK</label><input type="text" name="pengawas_nik_${i}" value="${identitas.pengawas[i].nik}" class="form-input"></div>
                        <div><label class="block text-sm">Periode</label><input type="text" name="pengawas_periode_${i}" value="${identitas.pengawas[i].periode}" class="form-input"></div>
                        <div class="md:col-span-2"><label class="block text-sm">Alamat</label><input type="text" name="pengawas_alamat_${i}" value="${identitas.pengawas[i].alamat}" class="form-input"></div>
                    </div>
                </div>
            `;
        }

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Identitas BUMDes & Kepengurusan</h3>
            <form id="form-identitas" class="space-y-6">
                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Data Umum</legend>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block">Nama BUMDes</label><input type="text" name="nama" value="${identitas.nama}" class="form-input"></div>
                        <div><label class="block">Status</label>
                            <select name="status" class="form-input">
                                <option value="BUMDesa" ${identitas.status === 'BUMDesa' ? 'selected' : ''}>BUMDesa</option>
                                <option value="BUMDesa Bersama" ${identitas.status === 'BUMDesa Bersama' ? 'selected' : ''}>BUMDesa Bersama</option>
                            </select>
                        </div>
                        <div><label class="block">No. AHU</label><input type="text" name="ahu" value="${identitas.ahu}" class="form-input"></div>
                        <div><label class="block">Status Aktif</label>
                            <select name="statusAktif" class="form-input">
                                <option value="Aktif" ${identitas.statusAktif === 'Aktif' ? 'selected' : ''}>Aktif</option>
                                <option value="Tidak Aktif" ${identitas.statusAktif === 'Tidak Aktif' ? 'selected' : ''}>Tidak Aktif</option>
                            </select>
                        </div>
                        <div><label class="block">Peringkat</label>
                            <select name="peringkat" class="form-input">
                                <option value="Level A (Maju)" ${identitas.peringkat === 'Level A (Maju)' ? 'selected' : ''}>Level A (Maju)</option>
                                <option value="Level B (Berkembang)" ${identitas.peringkat === 'Level B (Berkembang)' ? 'selected' : ''}>Level B (Berkembang)</option>
                                <option value="Level C (Pemula)" ${identitas.peringkat === 'Level C (Pemula)' ? 'selected' : ''}>Level C (Pemula)</option>
                            </select>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Pengelola Operasional</legend>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div class="p-3 border rounded-lg dark:border-gray-600 space-y-2">
                            <h5 class="font-semibold">Direktur</h5>
                            <div><label class="block text-sm">Nama</label><input type="text" name="direktur_nama" value="${identitas.pengelola.direktur.nama}" class="form-input"></div>
                            <div><label class="block text-sm">No. HP</label><input type="text" name="direktur_hp" value="${identitas.pengelola.direktur.hp}" class="form-input"></div>
                            <div><label class="block text-sm">NIK</label><input type="text" name="direktur_nik" value="${identitas.pengelola.direktur.nik}" class="form-input"></div>
                            <div><label class="block text-sm">Periode</label><input type="text" name="direktur_periode" value="${identitas.pengelola.direktur.periode}" class="form-input"></div>
                            <div><label class="block text-sm">Alamat</label><input type="text" name="direktur_alamat" value="${identitas.pengelola.direktur.alamat}" class="form-input"></div>
                        </div>
                        <div class="p-3 border rounded-lg dark:border-gray-600 space-y-2">
                            <h5 class="font-semibold">Sekretaris</h5>
                            <div><label class="block text-sm">Nama</label><input type="text" name="sekretaris_nama" value="${identitas.pengelola.sekretaris.nama}" class="form-input"></div>
                            <div><label class="block text-sm">No. HP</label><input type="text" name="sekretaris_hp" value="${identitas.pengelola.sekretaris.hp}" class="form-input"></div>
                            <div><label class="block text-sm">NIK</label><input type="text" name="sekretaris_nik" value="${identitas.pengelola.sekretaris.nik}" class="form-input"></div>
                            <div><label class="block text-sm">Periode</label><input type="text" name="sekretaris_periode" value="${identitas.pengelola.sekretaris.periode}" class="form-input"></div>
                            <div><label class="block text-sm">Alamat</label><input type="text" name="sekretaris_alamat" value="${identitas.pengelola.sekretaris.alamat}" class="form-input"></div>
                        </div>
                        <div class="p-3 border rounded-lg dark:border-gray-600 space-y-2">
                            <h5 class="font-semibold">Bendahara</h5>
                            <div><label class="block text-sm">Nama</label><input type="text" name="bendahara_nama" value="${identitas.pengelola.bendahara.nama}" class="form-input"></div>
                            <div><label class="block text-sm">No. HP</label><input type="text" name="bendahara_hp" value="${identitas.pengelola.bendahara.hp}" class="form-input"></div>
                            <div><label class="block text-sm">NIK</label><input type="text" name="bendahara_nik" value="${identitas.pengelola.bendahara.nik}" class="form-input"></div>
                            <div><label class="block text-sm">Periode</label><input type="text" name="bendahara_periode" value="${identitas.pengelola.bendahara.periode}" class="form-input"></div>
                            <div><label class="block text-sm">Alamat</label><input type="text" name="bendahara_alamat" value="${identitas.pengelola.bendahara.alamat}" class="form-input"></div>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Pengawas</legend>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        ${pengawasHtml}
                    </div>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Pendamping</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div class="p-3 border rounded-lg dark:border-gray-600 space-y-2">
                            <h5 class="font-semibold">Pendamping Desa</h5>
                            <div><label class="block text-sm">Nama</label><input type="text" name="pdesa_nama" value="${identitas.pendamping.desa.nama}" class="form-input"></div>
                            <div><label class="block text-sm">No. HP</label><input type="text" name="pdesa_hp" value="${identitas.pendamping.desa.hp}" class="form-input"></div>
                            <div><label class="block text-sm">NIK</label><input type="text" name="pdesa_nik" value="${identitas.pendamping.desa.nik}" class="form-input"></div>
                            <div><label class="block text-sm">Periode</label><input type="text" name="pdesa_periode" value="${identitas.pendamping.desa.periode}" class="form-input"></div>
                            <div><label class="block text-sm">Alamat</label><input type="text" name="pdesa_alamat" value="${identitas.pendamping.desa.alamat}" class="form-input"></div>
                        </div>
                        <div class="p-3 border rounded-lg dark:border-gray-600 space-y-2">
                            <h5 class="font-semibold">Pendamping Lokal Desa</h5>
                            <div><label class="block text-sm">Nama</label><input type="text" name="plokal_nama" value="${identitas.pendamping.lokal.nama}" class="form-input"></div>
                            <div><label class="block text-sm">No. HP</label><input type="text" name="plokal_hp" value="${identitas.pendamping.lokal.hp}" class="form-input"></div>
                            <div><label class="block text-sm">NIK</label><input type="text" name="plokal_nik" value="${identitas.pendamping.lokal.nik}" class="form-input"></div>
                            <div><label class="block text-sm">Periode</label><input type="text" name="plokal_periode" value="${identitas.pendamping.lokal.periode}" class="form-input"></div>
                            <div><label class="block text-sm">Alamat</label><input type="text" name="plokal_alamat" value="${identitas.pendamping.lokal.alamat}" class="form-input"></div>
                        </div>
                    </div>
                </fieldset>

                <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600">Simpan Semua Perubahan</button>
            </form>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"');
        
        el('#form-identitas').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const id = sikBumdesData.identitas;

            // Data Umum
            id.nama = form.nama.value;
            id.status = form.status.value;
            id.ahu = form.ahu.value;
            id.statusAktif = form.statusAktif.value;
            id.peringkat = form.peringkat.value;
            
            // Pengelola
            const pengelola = ['direktur', 'sekretaris', 'bendahara'];
            pengelola.forEach(p => {
                id.pengelola[p].nama = form[`${p}_nama`].value;
                id.pengelola[p].hp = form[`${p}_hp`].value;
                id.pengelola[p].nik = form[`${p}_nik`].value;
                id.pengelola[p].periode = form[`${p}_periode`].value;
                id.pengelola[p].alamat = form[`${p}_alamat`].value;
            });

            // Pengawas
            for(let i=0; i < 5; i++) {
                id.pengawas[i].nama = form[`pengawas_nama_${i}`].value;
                id.pengawas[i].hp = form[`pengawas_hp_${i}`].value;
                id.pengawas[i].nik = form[`pengawas_nik_${i}`].value;
                id.pengawas[i].periode = form[`pengawas_periode_${i}`].value;
                id.pengawas[i].alamat = form[`pengawas_alamat_${i}`].value;
            }

            // Pendamping
            id.pendamping.desa.nama = form.pdesa_nama.value;
            id.pendamping.desa.hp = form.pdesa_hp.value;
            id.pendamping.desa.nik = form.pdesa_nik.value;
            id.pendamping.desa.periode = form.pdesa_periode.value;
            id.pendamping.desa.alamat = form.pdesa_alamat.value;
            
            id.pendamping.lokal.nama = form.plokal_nama.value;
            id.pendamping.lokal.hp = form.plokal_hp.value;
            id.pendamping.lokal.nik = form.plokal_nik.value;
            id.pendamping.lokal.periode = form.plokal_periode.value;
            id.pendamping.lokal.alamat = form.plokal_alamat.value;

            saveData();
            showNotification('Data identitas dan kepengurusan berhasil disimpan!');
            renderDashboard();
        });
    }
    
    // --- Chart of Accounts (COA) ---
    function showCoaTable() {
        const tableHtml = `
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Daftar Akun (Chart of Accounts)</h3>
                <button id="btn-tambah-akun" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-600"><i class="fas fa-plus mr-2"></i>Tambah Akun</button>
            </div>
            <div class="overflow-auto max-h-[500px]">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                        <tr>
                            <th class="p-3">No. Akun</th>
                            <th class="p-3">Nama Akun</th>
                            <th class="p-3">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="coa-table-body"></tbody>
                </table>
            </div>
        `;
        inputDataContent.innerHTML = tableHtml;
        renderCoaTable();

        el('#btn-tambah-akun').addEventListener('click', () => showCoaModal());
    }
    
    function renderCoaTable() {
        const tbody = el('#coa-table-body');
        tbody.innerHTML = '';
        sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).forEach((akun, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `
                <td class="p-3">${akun.no}</td>
                <td class="p-3">${akun.nama}</td>
                <td class="p-3">
                    <button class="btn-edit-coa text-blue-500 hover:text-blue-700 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete-coa text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });

        all('.btn-edit-coa').forEach(btn => btn.addEventListener('click', (e) => showCoaModal(e.currentTarget.dataset.index)));
        all('.btn-delete-coa').forEach(btn => btn.addEventListener('click', (e) => deleteCoa(e.currentTarget.dataset.index)));
    }

    function showCoaModal(index = null) {
        const isEdit = index !== null;
        const akun = isEdit ? sikBumdesData.coa[index] : { no: '', nama: '' };
        const modalHtml = `
            <div id="coa-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Akun</h2>
                    <form id="form-coa">
                        <div class="mb-4">
                            <label class="block">No. Akun</label>
                            <input type="text" name="no" value="${akun.no}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <div class="mb-4">
                            <label class="block">Nama Akun</label>
                            <input type="text" name="nama" value="${akun.nama}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="btn-cancel-coa" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button>
                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        el('#modal-container').innerHTML = modalHtml;
        
        el('#form-coa').addEventListener('submit', (e) => {
            e.preventDefault();
            const newAkun = {
                no: e.target.no.value,
                nama: e.target.nama.value
            };
            if (isEdit) {
                sikBumdesData.coa[index] = newAkun;
            } else {
                sikBumdesData.coa.push(newAkun);
            }
            saveData();
            renderCoaTable();
            closeModal('coa-modal');
        });

        el('#btn-cancel-coa').addEventListener('click', () => closeModal('coa-modal'));
    }

    function deleteCoa(index) {
        if (confirm('Apakah Anda yakin ingin menghapus akun ini?')) {
            sikBumdesData.coa.splice(index, 1);
            saveData();
            renderCoaTable();
        }
    }

    // --- Jurnal ---
    function generateNomorBukti() {
        const { identitas, jurnalCounter } = sikBumdesData;
        const today = new Date().toISOString().slice(0, 10);
        const prefix = (identitas.nama || 'BM').substring(0, 2).toUpperCase();
        
        if (!jurnalCounter[today]) {
            jurnalCounter[today] = 0;
        }
        jurnalCounter[today]++;
        const seq = jurnalCounter[today].toString().padStart(3, '0');
        return `${prefix}-${today.replace(/-/g, '')}-${seq}`;
    }

    function showJurnalForm() {
        const coaOptions = sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).map(akun => `<option value="${akun.no}">${akun.no} - ${akun.nama}</option>`).join('');
        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Input Jurnal Umum</h3>
            <form id="form-jurnal" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block">Tanggal</label><input type="date" name="tanggal" value="${new Date().toISOString().slice(0,10)}" class="form-input" required></div>
                    <div><label class="block">No. Bukti</label><input type="text" name="bukti" readonly class="form-input bg-gray-200 dark:bg-gray-600"></div>
                </div>
                <div><label class="block">Keterangan</label><textarea name="keterangan" rows="2" class="form-input" required></textarea></div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4 mt-4">
                    <div>
                        <label class="block font-semibold mb-2">Akun DEBIT</label>
                        <select name="akunDebit" class="form-input mb-2" required>${coaOptions}</select>
                        <label class="block">Nominal</label>
                        <input type="number" name="nominal" class="form-input" placeholder="0" required>
                    </div>
                    <div>
                        <label class="block font-semibold mb-2">Akun KREDIT</label>
                        <select name="akunKredit" class="form-input mb-2" required>${coaOptions}</select>
                        <label class="block">Nominal</label>
                        <input type="number" name="nominalKredit" class="form-input bg-gray-200 dark:bg-gray-600" readonly>
                    </div>
                </div>

                <div class="text-right">
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Simpan Jurnal</button>
                </div>
            </form>
            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-4">Data Jurnal Terakhir</h3>
                <div class="overflow-auto max-h-[400px]">
                    <table class="w-full text-left">
                        <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                            <tr>
                                <th class="p-2">Tanggal</th><th class="p-2">No. Bukti</th><th class="p-2">Keterangan</th><th class="p-2">Akun</th><th class="p-2">Debit</th><th class="p-2">Kredit</th><th class="p-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="jurnal-table-body"></tbody>
                    </table>
                </div>
            </div>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        const form = el('#form-jurnal');
        form.bukti.value = generateNomorBukti();
        
        const nominalDebitInput = form.nominal;
        const nominalKreditInput = form.nominalKredit;
        nominalDebitInput.addEventListener('input', () => {
            nominalKreditInput.value = nominalDebitInput.value;
        });

        renderJurnalTable();
        form.addEventListener('submit', saveJurnal);
    }
    
    function saveJurnal(e) {
        e.preventDefault();
        const form = e.target;
        const nominal = parseFloat(form.nominal.value);

        if (!nominal || nominal <= 0) {
            showNotification('Nominal harus lebih besar dari nol.', 'error');
            return;
        }
        if (form.akunDebit.value === form.akunKredit.value) {
            showNotification('Akun Debit dan Kredit tidak boleh sama.', 'error');
            return;
        }

        const jurnalId = Date.now().toString();
        const commonData = {
            id: jurnalId,
            tanggal: form.tanggal.value,
            bukti: form.bukti.value,
            keterangan: form.keterangan.value,
        };

        // Entry Debit
        sikBumdesData.jurnal.push({
            ...commonData,
            akunNo: form.akunDebit.value,
            debit: nominal,
            credit: 0
        });

        // Entry Kredit
        sikBumdesData.jurnal.push({
            ...commonData,
            akunNo: form.akunKredit.value,
            debit: 0,
            credit: nominal
        });

        saveData();
        showNotification('Jurnal berhasil disimpan!');
        form.reset();
        form.tanggal.value = new Date().toISOString().slice(0,10);
        form.bukti.value = generateNomorBukti();
        renderJurnalTable();
    }

    function renderJurnalTable() {
        const tbody = el('#jurnal-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        const groupedJurnal = sikBumdesData.jurnal.reduce((acc, curr) => {
            (acc[curr.id] = acc[curr.id] || []).push(curr);
            return acc;
        }, {});

        Object.values(groupedJurnal).reverse().slice(0, 50).forEach(group => { // Show last 50 transactions
            const firstEntry = group[0];
            const rowSpan = group.length > 0 ? group.length : 1;
            group.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700';
                let firstCols = '';
                if (index === 0) {
                    firstCols = `
                        <td class="p-2" rowspan="${rowSpan}">${firstEntry.tanggal}</td>
                        <td class="p-2" rowspan="${rowSpan}">${firstEntry.bukti}</td>
                        <td class="p-2" rowspan="${rowSpan}">${firstEntry.keterangan}</td>
                    `;
                }
                const akun = sikBumdesData.coa.find(a => a.no === entry.akunNo);
                row.innerHTML = `
                    ${firstCols}
                    <td class="p-2">${akun ? akun.nama : 'Akun Dihapus'}</td>
                    <td class="p-2 text-right">${entry.debit > 0 ? formatCurrency(entry.debit) : ''}</td>
                    <td class="p-2 text-right">${entry.credit > 0 ? formatCurrency(entry.credit) : ''}</td>
                    ${index === 0 ? `<td class="p-2" rowspan="${rowSpan}"><button class="btn-delete-jurnal text-red-500" data-id="${firstEntry.id}"><i class="fas fa-trash"></i></button></td>` : ''}
                `;
                tbody.appendChild(row);
            });
        });
        
        all('.btn-delete-jurnal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                if (confirm('Yakin ingin menghapus seluruh entri jurnal ini?')) {
                    sikBumdesData.jurnal = sikBumdesData.jurnal.filter(j => j.id !== id);
                    saveData();
                    renderJurnalTable();
                }
            });
        });
    }

    // --- Inventaris ---
    function showInventarisForm() {
        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Input Inventaris</h3>
            <form id="form-inventaris" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4 mb-6">
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="block">Nama Barang</label><input type="text" name="nama" class="form-input" required></div>
                    <div><label class="block">Tanggal Beli</label><input type="date" name="tanggalBeli" class="form-input" required></div>
                    <div><label class="block">Harga Perolehan</label><input type="number" name="harga" class="form-input" required></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div><label class="block">Jumlah</label><input type="number" name="jumlah" value="1" class="form-input" required></div>
                    <div><label class="block">Umur Ekonomis (Tahun)</label><input type="number" name="umurEkonomis" class="form-input" required></div>
                </div>
                <div class="text-right">
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Simpan Inventaris</button>
                </div>
            </form>
            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-4">Data Inventaris</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-2">Nama</th><th class="p-2">Tgl Beli</th><th class="p-2">Harga</th><th class="p-2">Umur</th>
                                <th class="p-2">Penyusutan/Thn</th><th class="p-2">Akum. Penyusutan</th><th class="p-2">Nilai Buku</th><th class="p-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventaris-table-body"></tbody>
                    </table>
                </div>
            </div>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        renderInventarisTable();
        el('#form-inventaris').addEventListener('submit', saveInventaris);
    }

    function renderInventarisTable() {
        const tbody = el('#inventaris-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        sikBumdesData.inventaris.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';

            const harga = parseFloat(item.harga);
            const umur = parseFloat(item.umurEkonomis);
            const penyusutanPerTahun = umur > 0 ? harga / umur : 0;
            
            const tglBeli = new Date(item.tanggalBeli);
            const today = new Date();
            const yearsDiff = (today - tglBeli) / (1000 * 60 * 60 * 24 * 365.25);
            const yearsOwned = Math.max(0, Math.min(yearsDiff, umur));

            const akumulasiPenyusutan = penyusutanPerTahun * yearsOwned;
            const nilaiBuku = harga - akumulasiPenyusutan;

            row.innerHTML = `
                <td class="p-2">${item.nama}</td>
                <td class="p-2">${item.tanggalBeli}</td>
                <td class="p-2 text-right">${formatCurrency(harga)}</td>
                <td class="p-2 text-center">${item.umurEkonomis} thn</td>
                <td class="p-2 text-right">${formatCurrency(penyusutanPerTahun)}</td>
                <td class="p-2 text-right">${formatCurrency(akumulasiPenyusutan)}</td>
                <td class="p-2 text-right font-semibold">${formatCurrency(nilaiBuku)}</td>
                <td class="p-2">
                    <button class="btn-edit-inventaris text-blue-500 hover:text-blue-700 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete-inventaris text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });

        all('.btn-edit-inventaris').forEach(btn => btn.addEventListener('click', (e) => {
            const index = e.currentTarget.dataset.index;
            const item = sikBumdesData.inventaris[index];
            const form = el('#form-inventaris');
            form.id.value = item.id;
            form.nama.value = item.nama;
            form.tanggalBeli.value = item.tanggalBeli;
            form.harga.value = item.harga;
            form.jumlah.value = item.jumlah;
            form.umurEkonomis.value = item.umurEkonomis;
        }));
        all('.btn-delete-inventaris').forEach(btn => btn.addEventListener('click', (e) => {
            if (confirm('Yakin ingin menghapus item inventaris ini?')) {
                sikBumdesData.inventaris.splice(e.currentTarget.dataset.index, 1);
                saveData();
                renderInventarisTable();
            }
        }));
    }

    function saveInventaris(e) {
        e.preventDefault();
        const form = e.target;
        const id = form.id.value;
        const newItem = {
            id: id || `inv_${Date.now()}`,
            nama: form.nama.value,
            tanggalBeli: form.tanggalBeli.value,
            harga: parseFloat(form.harga.value),
            jumlah: parseInt(form.jumlah.value),
            umurEkonomis: parseFloat(form.umurEkonomis.value)
        };

        if (id) {
            const index = sikBumdesData.inventaris.findIndex(item => item.id === id);
            sikBumdesData.inventaris[index] = newItem;
        } else {
            sikBumdesData.inventaris.push(newItem);
        }
        
        saveData();
        renderInventarisTable();
        form.reset();
        form.id.value = '';
    }

    // --- Biaya Sewa ---
    function showSewaForm() {
        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Input Biaya Sewa Dibayar Dimuka</h3>
            <form id="form-sewa" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4 mb-6">
                <input type="hidden" name="id">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block">Objek Sewa (misal: Ruko, Mobil)</label><input type="text" name="objekSewa" class="form-input" required></div>
                    <div><label class="block">Nilai Sewa</label><input type="number" name="nilaiSewa" class="form-input" required></div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label class="block">Tanggal Mulai Sewa</label><input type="date" name="tanggalMulai" class="form-input" required></div>
                    <div><label class="block">Tanggal Selesai Sewa</label><input type="date" name="tanggalSelesai" class="form-input" required></div>
                </div>
                <div class="text-right">
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Simpan Biaya Sewa</button>
                </div>
            </form>
            <div class="mt-6">
                <h3 class="text-xl font-semibold mb-4">Data Biaya Sewa</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th class="p-2">Objek Sewa</th><th class="p-2">Periode</th><th class="p-2">Nilai Sewa</th>
                                <th class="p-2">Amortisasi/Bln</th><th class="p-2">Biaya yg Sudah Diakui</th><th class="p-2">Sisa Nilai</th><th class="p-2">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="sewa-table-body"></tbody>
                    </table>
                </div>
            </div>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        renderSewaTable();
        el('#form-sewa').addEventListener('submit', saveSewa);
    }

    function renderSewaTable() {
        const tbody = el('#sewa-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        sikBumdesData.biayaSewa.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';

            const nilaiSewa = parseFloat(item.nilaiSewa);
            const tglMulai = new Date(item.tanggalMulai);
            const tglSelesai = new Date(item.tanggalSelesai);
            const today = new Date();

            const totalMonths = (tglSelesai.getFullYear() - tglMulai.getFullYear()) * 12 + (tglSelesai.getMonth() - tglMulai.getMonth()) + 1;
            const amortisasiPerBulan = totalMonths > 0 ? nilaiSewa / totalMonths : 0;
            
            let monthsPassed = 0;
            if (today > tglMulai) {
                monthsPassed = (today.getFullYear() - tglMulai.getFullYear()) * 12 + (today.getMonth() - tglMulai.getMonth()) + 1;
                monthsPassed = Math.max(0, Math.min(monthsPassed, totalMonths));
            }
            
            const biayaDiakui = amortisasiPerBulan * monthsPassed;
            const sisaNilai = nilaiSewa - biayaDiakui;

            row.innerHTML = `
                <td class="p-2">${item.objekSewa}</td>
                <td class="p-2">${item.tanggalMulai} s/d ${item.tanggalSelesai}</td>
                <td class="p-2 text-right">${formatCurrency(nilaiSewa)}</td>
                <td class="p-2 text-right">${formatCurrency(amortisasiPerBulan)}</td>
                <td class="p-2 text-right">${formatCurrency(biayaDiakui)}</td>
                <td class="p-2 text-right font-semibold">${formatCurrency(sisaNilai)}</td>
                <td class="p-2">
                    <button class="btn-edit-sewa text-blue-500 hover:text-blue-700 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete-sewa text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>
                </td>
            `;
            tbody.appendChild(row);
        });

        all('.btn-edit-sewa').forEach(btn => btn.addEventListener('click', (e) => {
            const index = e.currentTarget.dataset.index;
            const item = sikBumdesData.biayaSewa[index];
            const form = el('#form-sewa');
            form.id.value = item.id;
            form.objekSewa.value = item.objekSewa;
            form.nilaiSewa.value = item.nilaiSewa;
            form.tanggalMulai.value = item.tanggalMulai;
            form.tanggalSelesai.value = item.tanggalSelesai;
        }));
        all('.btn-delete-sewa').forEach(btn => btn.addEventListener('click', (e) => {
            if (confirm('Yakin ingin menghapus data biaya sewa ini?')) {
                sikBumdesData.biayaSewa.splice(e.currentTarget.dataset.index, 1);
                saveData();
                renderSewaTable();
            }
        }));
    }

    function saveSewa(e) {
        e.preventDefault();
        const form = e.target;
        const id = form.id.value;
        const newItem = {
            id: id || `sewa_${Date.now()}`,
            objekSewa: form.objekSewa.value,
            nilaiSewa: parseFloat(form.nilaiSewa.value),
            tanggalMulai: form.tanggalMulai.value,
            tanggalSelesai: form.tanggalSelesai.value
        };

        if (id) {
            const index = sikBumdesData.biayaSewa.findIndex(item => item.id === id);
            sikBumdesData.biayaSewa[index] = newItem;
        } else {
            sikBumdesData.biayaSewa.push(newItem);
        }
        
        saveData();
        renderSewaTable();
        form.reset();
        form.id.value = '';
    }

    // --- UNIT USAHA ---
    function renderUnitUsahaTable() {
        const tbody = el('#unit-usaha-table-body');
        tbody.innerHTML = '';
        sikBumdesData.unitUsaha.forEach((unit, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `
                <td class="p-3">${unit.nama}</td>
                <td class="p-3">${unit.deskripsi}</td>
                <td class="p-3">
                    <button class="btn-edit-unit text-blue-500 hover:text-blue-700 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button>
                    ${unit.id !== 'utama' ? `<button class="btn-delete-unit text-red-500 hover:text-red-700" data-index="${index}"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            `;
            tbody.appendChild(row);
        });
        
        all('.btn-edit-unit').forEach(btn => btn.addEventListener('click', e => showUnitUsahaModal(e.currentTarget.dataset.index)));
        all('.btn-delete-unit').forEach(btn => btn.addEventListener('click', e => deleteUnitUsaha(e.currentTarget.dataset.index)));
    }
    
    el('#btn-tambah-unit').addEventListener('click', () => showUnitUsahaModal());
    
    function showUnitUsahaModal(index = null) {
        const isEdit = index !== null;
        const unit = isEdit ? sikBumdesData.unitUsaha[index] : { id: `unit_${Date.now()}`, nama: '', deskripsi: '' };
        const modalHtml = `
            <div id="unit-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Unit Usaha</h2>
                    <form id="form-unit">
                        <div class="mb-4">
                            <label class="block">Nama Unit</label>
                            <input type="text" name="nama" value="${unit.nama}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                        </div>
                        <div class="mb-4">
                            <label class="block">Deskripsi</label>
                            <textarea name="deskripsi" rows="3" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600">${unit.deskripsi}</textarea>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="btn-cancel-unit" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button>
                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        el('#modal-container').innerHTML = modalHtml;
        
        el('#form-unit').addEventListener('submit', (e) => {
            e.preventDefault();
            const newUnit = {
                id: unit.id,
                nama: e.target.nama.value,
                deskripsi: e.target.deskripsi.value
            };
            if (isEdit) {
                sikBumdesData.unitUsaha[index] = newUnit;
            } else {
                sikBumdesData.unitUsaha.push(newUnit);
            }
            saveData();
            renderUnitUsahaTable();
            closeModal('unit-modal');
        });

        el('#btn-cancel-unit').addEventListener('click', () => closeModal('unit-modal'));
    }

    function deleteUnitUsaha(index) {
        if (confirm('Yakin ingin menghapus unit usaha ini?')) {
            sikBumdesData.unitUsaha.splice(index, 1);
            saveData();
            renderUnitUsahaTable();
        }
    }

    // --- LAPORAN ---
    all('.btn-laporan').forEach(btn => {
        btn.addEventListener('click', () => {
            const reportType = btn.dataset.report;
            generateReport(reportType);
            all('.btn-laporan').forEach(b => b.classList.remove('bg-teal-500', 'text-white'));
            btn.classList.add('bg-teal-500', 'text-white');
        });
    });

    function generateReport(type) {
        const contentEl = el('#laporan-content');
        const controlsEl = el('#laporan-controls');
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().slice(0,10);
        const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString().slice(0,10);

        let controlsHtml = '';
        const dateControls = `
            <span id="date-range-controls">
                <label>Dari:</label> <input type="date" id="report-start-date" value="${firstDay}" class="form-control">
                <label>Sampai:</label> <input type="date" id="report-end-date" value="${lastDay}" class="form-control">
            </span>
        `;
        const singleDateControl = `
             <span id="single-date-controls">
                <label>Per Tanggal:</label> <input type="date" id="report-end-date" value="${lastDay}" class="form-control">
            </span>
        `;
        
        switch(type) {
            case 'buku-besar':
                const coaOptions = sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).map(akun => `<option value="${akun.no}">${akun.no} - ${akun.nama}</option>`).join('');
                controlsHtml += `<label>Akun:</label> <select id="report-akun-select" class="form-control">${coaOptions}</select>${dateControls}`;
                break;
            case 'inventaris':
            case 'biaya-sewa':
            case 'posisi-keuangan':
            case 'neraca-saldo':
                controlsHtml += singleDateControl;
                break;
            default:
                controlsHtml += dateControls;
        }

        controlsHtml += `
            <button id="btn-filter-report" class="bg-blue-500 text-white px-3 py-1 rounded">Tampilkan</button>
            <button id="btn-print-report" class="bg-green-500 text-white px-3 py-1 rounded"><i class="fas fa-print"></i> Cetak</button>
        `;
        controlsEl.innerHTML = controlsHtml.replace(/class="form-control"/g, 'class="p-1 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        const renderFunction = () => {
            let reportHtml = '';
            const startDate = el('#report-start-date') ? el('#report-start-date').value : null;
            const endDate = el('#report-end-date').value;
            
            switch (type) {
                case 'laba-rugi': reportHtml = generateLabaRugi(startDate, endDate); break;
                case 'posisi-keuangan': reportHtml = generatePosisiKeuangan(endDate); break;
                case 'neraca-saldo': reportHtml = generateNeracaSaldo(endDate); break;
                case 'buku-besar': reportHtml = generateBukuBesar(el('#report-akun-select').value, startDate, endDate); break;
                case 'arus-kas': reportHtml = generateArusKas(startDate, endDate); break;
                case 'inventaris': reportHtml = generateLaporanInventaris(endDate); break;
                case 'biaya-sewa': reportHtml = generateLaporanSewa(endDate); break;
                case 'penjualan': reportHtml = generateLaporanPenjualan(startDate, endDate); break;
                case 'stok': reportHtml = generateLaporanStok(endDate); break;
                default: reportHtml = `<p class="text-center text-gray-500">Laporan '${type}' belum tersedia.</p>`;
            }
            contentEl.innerHTML = reportHtml;
        };

        el('#btn-filter-report').addEventListener('click', renderFunction);
        el('#btn-print-report').addEventListener('click', () => {
            const reportTitle = getReportTitle(type);
            const period = el('#report-start-date') 
                ? `Periode ${el('#report-start-date').value} s/d ${el('#report-end-date').value}`
                : `Per Tanggal ${el('#report-end-date').value}`;
            printReportWithHeader(reportTitle, period, contentEl.innerHTML);
        });
        renderFunction();
    }
    
    function getReportTitle(type) {
        const titles = {
            'laba-rugi': 'Laporan Laba Rugi', 'posisi-keuangan': 'Laporan Posisi Keuangan (Neraca)', 'neraca-saldo': 'Laporan Neraca Saldo',
            'buku-besar': 'Laporan Buku Besar', 'arus-kas': 'Laporan Arus Kas', 'inventaris': 'Laporan Daftar Inventaris',
            'biaya-sewa': 'Laporan Biaya Sewa Dibayar Dimuka', 'penjualan': 'Laporan Penjualan per Unit Usaha', 'stok': 'Laporan Nilai Stok Barang'
        };
        return titles[type] || 'Laporan';
    }

    function generateLabaRugi(startDate, endDate) {
        const filteredJurnal = sikBumdesData.jurnal.filter(j => j.tanggal >= startDate && j.tanggal <= endDate);
        let pendapatan = {}; let biaya = {};
        let totalPendapatan = 0; let totalBiaya = 0;

        filteredJurnal.forEach(j => {
            const akun = sikBumdesData.coa.find(a => a.no === j.akunNo);
            if (!akun) return;
            if (j.akunNo.startsWith('4')) {
                if (!pendapatan[j.akunNo]) pendapatan[j.akunNo] = { nama: akun.nama, total: 0 };
                pendapatan[j.akunNo].total += j.credit - j.debit;
            } else if (j.akunNo.startsWith('5')) {
                if (!biaya[j.akunNo]) biaya[j.akunNo] = { nama: akun.nama, total: 0 };
                biaya[j.akunNo].total += j.debit - j.credit;
            }
        });
        
        let html = '<table class="w-full report-table">';
        html += '<tr><td colspan="2" class="font-bold py-2">Pendapatan</td></tr>';
        Object.values(pendapatan).forEach(p => {
            html += `<tr><td class="pl-4">${p.nama}</td><td class="text-right">${formatCurrency(p.total)}</td></tr>`;
            totalPendapatan += p.total;
        });
        html += `<tr><td class="font-bold border-t pt-2">Total Pendapatan</td><td class="font-bold text-right border-t pt-2">${formatCurrency(totalPendapatan)}</td></tr>`;

        html += '<tr><td colspan="2" class="font-bold py-2 mt-4">Biaya-biaya</td></tr>';
        Object.values(biaya).forEach(b => {
             html += `<tr><td class="pl-4">${b.nama}</td><td class="text-right">${formatCurrency(b.total)}</td></tr>`;
            totalBiaya += b.total;
        });
        html += `<tr><td class="font-bold border-t pt-2">Total Biaya</td><td class="font-bold text-right border-t pt-2">${formatCurrency(totalBiaya)}</td></tr>`;
        
        const labaRugi = totalPendapatan - totalBiaya;
        html += `<tr><td class="font-bold text-lg border-t-2 pt-2">Laba (Rugi) Bersih</td><td class="font-bold text-lg text-right border-t-2 pt-2 ${labaRugi < 0 ? 'text-red-500' : ''}">${formatCurrency(labaRugi)}</td></tr>`;
        html += '</table>';
        return html;
    }
    
    function generatePosisiKeuangan(endDate) { 
        const filteredJurnal = sikBumdesData.jurnal.filter(j => j.tanggal <= endDate);
        const balances = {};
        
        filteredJurnal.forEach(j => {
            if (!balances[j.akunNo]) balances[j.akunNo] = 0;
            const type = j.akunNo.charAt(0);
            if (['1', '5'].includes(type)) {
                balances[j.akunNo] += j.debit - j.credit;
            } else {
                balances[j.akunNo] += j.credit - j.debit;
            }
        });

        let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-8">';
        
        // ASET
        html += '<div><h4 class="font-bold text-lg mb-2 border-b">ASET</h4>';
        let totalAset = 0;
        sikBumdesData.coa.filter(a => a.no.startsWith('1')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = balances[akun.no] || 0;
            if (balance !== 0) {
                html += `<div class="flex justify-between"><span>${akun.nama}</span><span>${formatCurrency(balance)}</span></div>`;
                totalAset += balance;
            }
        });
        html += `<div class="flex justify-between font-bold border-t mt-2 pt-2"><span>Total Aset</span><span>${formatCurrency(totalAset)}</span></div></div>`;
        
        // KEWAJIBAN & EKUITAS
        html += '<div><h4 class="font-bold text-lg mb-2 border-b">KEWAJIBAN & EKUITAS</h4>';
        html += '<h5 class="font-semibold mt-2">Kewajiban</h5>';
        let totalKewajiban = 0;
        sikBumdesData.coa.filter(a => a.no.startsWith('2')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = balances[akun.no] || 0;
            if (balance !== 0) {
                html += `<div class="flex justify-between"><span>${akun.nama}</span><span>${formatCurrency(balance)}</span></div>`;
                totalKewajiban += balance;
            }
        });
        html += `<div class="flex justify-between font-semibold border-t mt-1 pt-1"><span>Total Kewajiban</span><span>${formatCurrency(totalKewajiban)}</span></div>`;

        html += '<h5 class="font-semibold mt-4">Ekuitas</h5>';
        let totalEkuitas = 0;
        sikBumdesData.coa.filter(a => a.no.startsWith('3')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = balances[akun.no] || 0;
            if (balance !== 0) {
                html += `<div class="flex justify-between"><span>${akun.nama}</span><span>${formatCurrency(balance)}</span></div>`;
                totalEkuitas += balance;
            }
        });
        html += `<div class="flex justify-between font-semibold border-t mt-1 pt-1"><span>Total Ekuitas</span><span>${formatCurrency(totalEkuitas)}</span></div>`;
        
        const totalPasiva = totalKewajiban + totalEkuitas;
        html += `<div class="flex justify-between font-bold border-t mt-2 pt-2"><span>Total Kewajiban & Ekuitas</span><span>${formatCurrency(totalPasiva)}</span></div></div>`;

        html += '</div>';
        return html;
    }

    function generateNeracaSaldo(endDate) {
        const filteredJurnal = sikBumdesData.jurnal.filter(j => j.tanggal <= endDate);
        const balances = {};
        
        filteredJurnal.forEach(j => {
            if (!balances[j.akunNo]) balances[j.akunNo] = { debit: 0, credit: 0 };
            balances[j.akunNo].debit += j.debit;
            balances[j.akunNo].credit += j.credit;
        });

        let html = `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr><th class="p-2">No. Akun</th><th class="p-2">Nama Akun</th><th class="p-2 text-right">Debit</th><th class="p-2 text-right">Kredit</th></tr>
            </thead><tbody>`;
        
        let totalDebit = 0;
        let totalCredit = 0;

        sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = balances[akun.no] || { debit: 0, credit: 0 };
            const type = akun.no.charAt(0);
            let saldoDebit = 0;
            let saldoKredit = 0;
            
            if (['1', '5'].includes(type)) { // Saldo normal debit
                const saldo = balance.debit - balance.credit;
                if (saldo > 0) saldoDebit = saldo;
                else if (saldo < 0) saldoKredit = -saldo;
            } else { // Saldo normal kredit
                const saldo = balance.credit - balance.debit;
                if (saldo > 0) saldoKredit = saldo;
                else if (saldo < 0) saldoDebit = -saldo;
            }

            if (saldoDebit !== 0 || saldoKredit !== 0) {
                html += `<tr>
                    <td class="p-2">${akun.no}</td>
                    <td class="p-2">${akun.nama}</td>
                    <td class="p-2 text-right">${formatCurrency(saldoDebit)}</td>
                    <td class="p-2 text-right">${formatCurrency(saldoKredit)}</td>
                </tr>`;
                totalDebit += saldoDebit;
                totalCredit += saldoKredit;
            }
        });
        
        html += `</tbody><tfoot class="font-bold border-t-2">
            <tr><td class="p-2" colspan="2">Total</td>
            <td class="p-2 text-right">${formatCurrency(totalDebit)}</td>
            <td class="p-2 text-right">${formatCurrency(totalCredit)}</td></tr>
        </tfoot></table>`;
        
        return html;
    }

    function generateBukuBesar(akunNo, startDate, endDate) {
        const jurnalSebelum = sikBumdesData.jurnal.filter(j => j.tanggal < startDate && j.akunNo === akunNo);
        const jurnalPeriode = sikBumdesData.jurnal.filter(j => j.tanggal >= startDate && j.tanggal <= endDate && j.akunNo === akunNo);
        const akun = sikBumdesData.coa.find(a => a.no === akunNo);
        if (!akun) return '<p>Akun tidak ditemukan.</p>';

        let saldoAwal = 0;
        const isDebitNormal = ['1', '5'].includes(akunNo.charAt(0));
        jurnalSebelum.forEach(j => {
            saldoAwal += isDebitNormal ? (j.debit - j.credit) : (j.credit - j.debit);
        });

        let html = `<div class="mb-2"><b>Nomor Akun:</b> ${akunNo}<br><b>Nama Akun:</b> ${akun.nama}</div>`;
        html += `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr><th class="p-2">Tanggal</th><th class="p-2">Keterangan</th><th class="p-2 text-right">Debit</th><th class="p-2 text-right">Kredit</th><th class="p-2 text-right">Saldo</th></tr>
            </thead><tbody>
                <tr><td colspan="4" class="p-2 font-bold">Saldo Awal</td><td class="p-2 text-right font-bold">${formatCurrency(saldoAwal)}</td></tr>
        `;

        let saldoBerjalan = saldoAwal;
        jurnalPeriode.forEach(j => {
            saldoBerjalan += isDebitNormal ? (j.debit - j.credit) : (j.credit - j.debit);
            html += `<tr>
                <td class="p-2">${j.tanggal}</td><td class="p-2">${j.keterangan}</td>
                <td class="p-2 text-right">${formatCurrency(j.debit)}</td><td class="p-2 text-right">${formatCurrency(j.credit)}</td>
                <td class="p-2 text-right">${formatCurrency(saldoBerjalan)}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        return html;
    }
    function generateArusKas(startDate, endDate) { return '<p class="text-center text-gray-500">Laporan Arus Kas sedang dalam pengembangan.</p>'; }
    function generateLaporanInventaris(endDate) {
        let html = `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr><th class="p-2">Nama</th><th class="p-2">Tgl Beli</th><th class="p-2 text-right">Harga</th><th class="p-2 text-center">Umur</th>
                <th class="p-2 text-right">Penyusutan/Thn</th><th class="p-2 text-right">Akum. Penyusutan</th><th class="p-2 text-right">Nilai Buku</th></tr>
            </thead><tbody>`;
        
        let totalHarga = 0, totalAkumulasi = 0, totalNilaiBuku = 0;
        sikBumdesData.inventaris.forEach(item => {
            const harga = parseFloat(item.harga);
            const umur = parseFloat(item.umurEkonomis);
            const penyusutanPerTahun = umur > 0 ? harga / umur : 0;
            const tglBeli = new Date(item.tanggalBeli);
            const tglLaporan = new Date(endDate);
            const yearsDiff = (tglLaporan - tglBeli) / (1000 * 60 * 60 * 24 * 365.25);
            const yearsOwned = Math.max(0, Math.min(yearsDiff, umur));
            const akumulasiPenyusutan = penyusutanPerTahun * yearsOwned;
            const nilaiBuku = harga - akumulasiPenyusutan;
            
            totalHarga += harga;
            totalAkumulasi += akumulasiPenyusutan;
            totalNilaiBuku += nilaiBuku;

            html += `<tr>
                <td class="p-2">${item.nama}</td><td class="p-2">${item.tanggalBeli}</td><td class="p-2 text-right">${formatCurrency(harga)}</td>
                <td class="p-2 text-center">${item.umurEkonomis} thn</td><td class="p-2 text-right">${formatCurrency(penyusutanPerTahun)}</td>
                <td class="p-2 text-right">${formatCurrency(akumulasiPenyusutan)}</td><td class="p-2 text-right font-semibold">${formatCurrency(nilaiBuku)}</td>
            </tr>`;
        });
        html += `</tbody><tfoot class="font-bold border-t-2">
            <tr><td class="p-2" colspan="2">Total</td><td class="p-2 text-right">${formatCurrency(totalHarga)}</td><td colspan="2"></td>
            <td class="p-2 text-right">${formatCurrency(totalAkumulasi)}</td><td class="p-2 text-right">${formatCurrency(totalNilaiBuku)}</td></tr>
        </tfoot></table>`;
        return html;
    }
    function generateLaporanSewa(endDate) {
        let html = `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr><th class="p-2">Objek Sewa</th><th class="p-2">Periode</th><th class="p-2 text-right">Nilai Sewa</th>
                <th class="p-2 text-right">Amortisasi/Bln</th><th class="p-2 text-right">Biaya Diakui</th><th class="p-2 text-right">Sisa Nilai</th></tr>
            </thead><tbody>`;
        
        let totalNilai = 0, totalDiakui = 0, totalSisa = 0;
        sikBumdesData.biayaSewa.forEach(item => {
            const nilaiSewa = parseFloat(item.nilaiSewa);
            const tglMulai = new Date(item.tanggalMulai);
            const tglSelesai = new Date(item.tanggalSelesai);
            const tglLaporan = new Date(endDate);
            const totalMonths = (tglSelesai.getFullYear() - tglMulai.getFullYear()) * 12 + (tglSelesai.getMonth() - tglMulai.getMonth()) + 1;
            const amortisasiPerBulan = totalMonths > 0 ? nilaiSewa / totalMonths : 0;
            let monthsPassed = 0;
            if (tglLaporan > tglMulai) {
                monthsPassed = (tglLaporan.getFullYear() - tglMulai.getFullYear()) * 12 + (tglLaporan.getMonth() - tglMulai.getMonth()) + 1;
                monthsPassed = Math.max(0, Math.min(monthsPassed, totalMonths));
            }
            const biayaDiakui = amortisasiPerBulan * monthsPassed;
            const sisaNilai = nilaiSewa - biayaDiakui;

            totalNilai += nilaiSewa;
            totalDiakui += biayaDiakui;
            totalSisa += sisaNilai;

            html += `<tr>
                <td class="p-2">${item.objekSewa}</td><td class="p-2">${item.tanggalMulai} s/d ${item.tanggalSelesai}</td>
                <td class="p-2 text-right">${formatCurrency(nilaiSewa)}</td><td class="p-2 text-right">${formatCurrency(amortisasiPerBulan)}</td>
                <td class="p-2 text-right">${formatCurrency(biayaDiakui)}</td><td class="p-2 text-right font-semibold">${formatCurrency(sisaNilai)}</td>
            </tr>`;
        });
        html += `</tbody><tfoot class="font-bold border-t-2">
            <tr><td class="p-2" colspan="2">Total</td><td class="p-2 text-right">${formatCurrency(totalNilai)}</td><td></td>
            <td class="p-2 text-right">${formatCurrency(totalDiakui)}</td><td class="p-2 text-right">${formatCurrency(totalSisa)}</td></tr>
        </tfoot></table>`;
        return html;
    }
    function generateLaporanPenjualan(startDate, endDate) {
        const filteredJurnal = sikBumdesData.jurnal.filter(j => j.tanggal >= startDate && j.tanggal <= endDate && j.akunNo.startsWith('4'));
        const penjualanPerUnit = {};

        filteredJurnal.forEach(j => {
            const unit = sikBumdesData.unitUsaha.find(u => u.id === j.unitId) || { id: 'utama', nama: 'Umum/Kantor' };
            if (!penjualanPerUnit[unit.id]) {
                penjualanPerUnit[unit.id] = { nama: unit.nama, total: 0 };
            }
            penjualanPerUnit[unit.id].total += j.credit - j.debit;
        });

        let html = `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr><th class="p-2">Unit Usaha</th><th class="p-2 text-right">Total Penjualan</th></tr>
            </thead><tbody>`;
        
        let totalPenjualan = 0;
        Object.values(penjualanPerUnit).forEach(unit => {
            html += `<tr><td class="p-2">${unit.nama}</td><td class="p-2 text-right">${formatCurrency(unit.total)}</td></tr>`;
            totalPenjualan += unit.total;
        });
        html += `</tbody><tfoot class="font-bold border-t-2">
            <tr><td class="p-2">Total Seluruh Unit</td><td class="p-2 text-right">${formatCurrency(totalPenjualan)}</td></tr>
        </tfoot></table>`;
        return html;
    }
    function generateLaporanStok(endDate) { return '<p class="text-center text-gray-500">Laporan Stok berdasarkan kuantitas belum tersedia. Hanya nilai persediaan yang dapat dilihat di Neraca.</p>'; }
    
    function printReportWithHeader(reportTitle, period, content) {
        const { identitas, pengaturan } = sikBumdesData;
        const header = `
            <div style="border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px; display: flex; align-items: center;">
                <img src="${pengaturan.logo}" alt="Logo" style="width: 70px; height: 70px; margin-right: 20px;">
                <div style="text-align: center; flex-grow: 1;">
                    <h2 style="font-size: 1.5rem; font-weight: bold; margin: 0;">${identitas.nama.toUpperCase()}</h2>
                    <p style="margin: 0; font-size: 1rem;">Nomor AHU: ${identitas.ahu || '-'}</p>
                    <p style="margin: 0; font-size: 0.9rem;">${identitas.alamat.jalan}, ${identitas.alamat.desa}, ${identitas.alamat.kec}, ${identitas.alamat.kab}</p>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 20px;">
                <h3 style="font-size: 1.2rem; font-weight: bold; margin: 0; text-decoration: underline;">${reportTitle}</h3>
                <p style="margin: 0;">${period}</p>
            </div>
        `;
        const footer = `
            <div style="margin-top: 50px; width: 100%; text-align: right;">
                <div style="display: inline-block; text-align: center;">
                    <p>${identitas.alamat.desa}, ${new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'long', year: 'numeric' })}</p>
                    <p>Direktur BUMDes,</p>
                    <br><br><br>
                    <p style="text-decoration: underline; font-weight: bold;">${identitas.pengelola.direktur.nama || '(.........................)'}</p>
                </div>
            </div>
        `;
        el('#print-area').innerHTML = `<div style="font-family: 'Times New Roman', serif;">${header}${content}${footer}</div>`;
        el('#print-area').classList.remove('hidden');
        window.print();
        el('#print-area').classList.add('hidden');
    }

    // --- ADMINISTRASI ---
    el('#form-upload-dokumen').addEventListener('submit', (e) => {
        e.preventDefault();
        const jenis = el('#select-jenis-dokumen').value;
        const fileInput = el('#input-file-dokumen');
        if (fileInput.files.length === 0) {
            showNotification('Pilih file terlebih dahulu!', 'error');
            return;
        }
        const file = fileInput.files[0];
        const reader = new FileReader();
        reader.onloadend = function() {
            sikBumdesData.dokumen[jenis] = { name: file.name, type: file.type, data: reader.result };
            saveData();
            renderDokumenList();
            showNotification('Dokumen berhasil diupload.');
        }
        reader.readAsDataURL(file);
    });

    function renderDokumenList() {
        const listEl = el('#list-dokumen');
        listEl.innerHTML = '';
        const { dokumen } = sikBumdesData;
        for (const key in dokumen) {
            if (dokumen[key]) {
                const doc = dokumen[key];
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded';
                item.innerHTML = `
                    <span><i class="fas fa-file-alt mr-2"></i>${key.toUpperCase()}: ${doc.name}</span>
                    <div>
                        <a href="${doc.data}" download="${doc.name}" class="text-blue-500 mr-3"><i class="fas fa-download"></i></a>
                        <button class="btn-delete-dokumen text-red-500" data-key="${key}"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                listEl.appendChild(item);
            }
        }
        all('.btn-delete-dokumen').forEach(btn => btn.addEventListener('click', e => {
            const key = e.currentTarget.dataset.key;
            if (confirm(`Yakin ingin menghapus dokumen ${key.toUpperCase()}?`)) {
                sikBumdesData.dokumen[key] = null;
                saveData();
                renderDokumenList();
            }
        }));
    }
    function renderMusyawarahList() { /* ... */ }

    // --- PENGATURAN ---
    function loadPengaturan() {
        el('#logo-preview').src = sikBumdesData.pengaturan.logo;
    }
    
    function renderPenggunaTable() {
        const tbody = el('#pengguna-table-body');
        tbody.innerHTML = '';
        sikBumdesData.pengguna.forEach((user, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `
                <td class="p-3">${user.username}</td>
                <td class="p-3">${user.peran}</td>
                <td class="p-3">
                    <button class="btn-edit-user text-blue-500 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button>
                    ${user.username !== 'admin' ? `<button class="btn-delete-user text-red-500" data-index="${index}"><i class="fas fa-trash"></i></button>` : ''}
                </td>
            `;
            tbody.appendChild(row);
        });
        all('.btn-edit-user').forEach(btn => btn.addEventListener('click', e => showPenggunaModal(e.currentTarget.dataset.index)));
        all('.btn-delete-user').forEach(btn => btn.addEventListener('click', e => deletePengguna(e.currentTarget.dataset.index)));
    }
    
    el('#btn-tambah-pengguna').addEventListener('click', () => showPenggunaModal());

    function showPenggunaModal(index = null) {
        const isEdit = index !== null;
        const user = isEdit ? sikBumdesData.pengguna[index] : { username: '', password: '', peran: 'Operator' };
        const modalHtml = `
            <div id="user-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Pengguna</h2>
                    <form id="form-user">
                        <div class="mb-4">
                            <label class="block">Username</label>
                            <input type="text" name="username" value="${user.username}" class="w-full p-2 border rounded" ${isEdit && user.username === 'admin' ? 'readonly' : ''} required>
                        </div>
                        <div class="mb-4">
                            <label class="block">Password</label>
                            <input type="password" name="password" placeholder="${isEdit ? 'Kosongkan jika tidak diubah' : ''}" class="w-full p-2 border rounded" ${!isEdit ? 'required' : ''}>
                        </div>
                        <div class="mb-4">
                            <label class="block">Peran</label>
                            <select name="peran" class="w-full p-2 border rounded">
                                <option value="Admin" ${user.peran === 'Admin' ? 'selected' : ''}>Admin</option>
                                <option value="Operator" ${user.peran === 'Operator' ? 'selected' : ''}>Operator</option>
                                <option value="Pengawas" ${user.peran === 'Pengawas' ? 'selected' : ''}>Pengawas</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="btn-cancel-user" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button>
                            <button type="submit" class="bg-teal-500 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        el('#modal-container').innerHTML = modalHtml.replace(/class="w-full p-2 border rounded"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        el('#form-user').addEventListener('submit', e => {
            e.preventDefault();
            const form = e.target;
            const newUser = {
                username: form.username.value,
                password: form.password.value || user.password,
                peran: form.peran.value,
            };
            if (isEdit) {
                sikBumdesData.pengguna[index] = newUser;
            } else {
                sikBumdesData.pengguna.push(newUser);
            }
            saveData();
            renderPenggunaTable();
            closeModal('user-modal');
            showNotification('Data pengguna berhasil disimpan!');
        });
        el('#btn-cancel-user').addEventListener('click', () => closeModal('user-modal'));
    }
    
    function deletePengguna(index) {
        if (confirm('Yakin ingin menghapus pengguna ini?')) {
            sikBumdesData.pengguna.splice(index, 1);
            saveData();
            renderPenggunaTable();
        }
    }
    
    el('#logo-upload').addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = 80;
                    canvas.height = 80;
                    ctx.drawImage(img, 0, 0, 80, 80);
                    el('#logo-preview').src = canvas.toDataURL(e.target.files[0].type);
                };
                img.src = event.target.result;
            }
            reader.readAsDataURL(e.target.files[0]);
        }
    });
    
    el('#btn-simpan-logo').addEventListener('click', () => {
        sikBumdesData.pengaturan.logo = el('#logo-preview').src;
        saveData();
        showNotification('Logo berhasil disimpan!');
        renderDashboard(); // Update logo on dashboard
    });

    el('#btn-backup-data').addEventListener('click', () => {
        const dataStr = JSON.stringify(sikBumdesData, null, 2);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = `sik-bumdes-backup-${new Date().toISOString().slice(0,10)}.json`;
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    });

    el('#restore-upload').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (confirm('Ini akan menimpa semua data saat ini. Lanjutkan?')) {
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const restoredData = JSON.parse(event.target.result);
                    if (restoredData.identitas && restoredData.coa) {
                        localStorage.setItem('sikBumdesData', JSON.stringify(restoredData));
                        showNotification('Data berhasil dipulihkan! Aplikasi akan dimuat ulang.');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        showNotification('File backup tidak valid.', 'error');
                    }
                } catch (error) {
                    showNotification('Gagal membaca file backup.', 'error');
                }
            };
            reader.readAsText(file);
        }
    });

    // --- MODAL HELPER ---
    function closeModal(modalId) {
        const modal = el(`#${modalId}`);
        if (modal) modal.remove();
    }

    // --- START THE APP ---
    initializeApp();
});
</script>
</body>
</html>
